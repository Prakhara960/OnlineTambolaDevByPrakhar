<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IntelliTambola — Family Tambola</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#071428;--card:#07263a;--muted:#9fb0c6;--accent:#ffb703}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#051023,#06142a);color:#e7f0f7}
.container{max-width:1100px;margin:18px auto;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
h1{margin:0;font-size:20px}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:12px;margin-top:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
.controls{display:flex;gap:8px;flex-wrap:wrap}
input,select,button,textarea{padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:inherit}
button{cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
.ticket{padding:10px;border-radius:10px;background:linear-gradient(180deg,#062033,#042235)}
.ticket-table{width:100%;border-collapse:collapse}
.ticket-table td{padding:6px;text-align:center;border-radius:6px}
.empty{opacity:0.12}
.num-badge{display:inline-block;width:36px;height:36px;line-height:36px;border-radius:8px;text-align:center;margin:4px;background:rgba(255,255,255,0.03)}
.num-drawn{background:linear-gradient(90deg,#06b6d4,#0ea5a4);color:#012b2b;font-weight:700}
.small{font-size:13px;color:var(--muted)}
.chat-box{max-height:240px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02)}
.footer{margin-top:14px;font-size:12px;color:var(--muted)}
@media (max-width:600px){.controls{flex-direction:column}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>IntelliTambola</h1>
      <div class="small">Create room → Share code → Players join</div>
    </div>

    <div class="card">
      <div class="controls">
        <input id="hostName" placeholder="Host ka naam (optional)">
        <input id="maxPlayers" type="number" min="2" value="50" style="width:110px">
        <button id="createRoomBtn">Create Room</button>
        <div style="margin-left:auto" class="small">Backend: <span id="backendUrl"></span></div>
      </div>
      <div class="small" style="margin-top:8px">Host create karte waqt dividends set karne ke liye Advanced mode me edit kar sakte ho.</div>
    </div>

    <div class="card" style="display:flex;gap:8px;align-items:center">
      <input id="joinRoomId" placeholder="Room code" style="width:170px">
      <input id="playerName" placeholder="Apna naam">
      <button id="joinBtn">Join</button>
      <button id="refreshBtn">Refresh</button>
      <div style="margin-left:auto" class="small">Local: <span id="localInfo"></span></div>
    </div>

    <div id="roomArea"></div>

    <div class="footer">Tip: Open this page in multiple browsers/incognito windows to test host + multiple players.</div>
  </div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbyyccNpuQbAK-eeS5X4Y4MCr3oGrUcJFU4T-UwkB2iprXuzSbLzlXIytv-32xK-2cIa/exec'; // <-- REPLACE
document.getElementById('backendUrl').innerText = GAS_URL;
document.getElementById('localInfo').innerText = navigator.userAgent.split(') ')[0];

async function api(action, payload){
  payload = payload || {}; payload.action = action;
  const res = await fetch(GAS_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  return await res.json();
}

// Create room
document.getElementById('createRoomBtn').addEventListener('click', async ()=>{
  const hostName = document.getElementById('hostName').value || 'Host';
  const maxPlayers = +document.getElementById('maxPlayers').value || 50;
  const dividends = {earlyFive:200, line:100, fullHouse:1000};
  const r = await api('createRoom', {hostName, maxPlayers, dividends});
  if(r.ok){ localStorage.setItem('roomId', r.roomId); localStorage.setItem('hostToken', r.hostToken); localStorage.setItem('hostName', hostName); alert('Room created: ' + r.roomId); renderRoom(); } else alert('Err:'+ (r.error||''));
});

// Join
document.getElementById('joinBtn').addEventListener('click', async ()=>{
  const roomId = document.getElementById('joinRoomId').value.trim();
  const name = document.getElementById('playerName').value.trim() || ('Player'+Math.floor(Math.random()*99));
  if(!roomId) return alert('Room code daal do');
  const r = await api('joinRoom', {roomId, name});
  if(r.ok){ localStorage.setItem('playerId', r.playerId); localStorage.setItem('ticketId', r.ticketId); localStorage.setItem('roomId', roomId); alert('Joined!'); renderRoom(); } else alert('Err:'+ (r.error||''));
});

document.getElementById('refreshBtn').addEventListener('click', renderRoom);

// Host draw
async function hostDraw(){
  const roomId = localStorage.getItem('roomId'); const hostToken = localStorage.getItem('hostToken');
  if(!roomId || !hostToken) return alert('You are not host or no room selected');
  const r = await api('drawNumber', {roomId, hostToken});
  if(r.ok){ alert('Number drawn: ' + r.number); await api('checkWinners',{roomId}); renderRoom(); } else alert('Err:'+ (r.error||''));
}

// Regenerate ticket for current player
async function regenerateTicket(){
  const playerId = localStorage.getItem('playerId'); const roomId = localStorage.getItem('roomId');
  if(!playerId) return alert('You are not a player');
  const r = await api('regenerateTicket', {playerId, roomId});
  if(r.ok){ alert('Ticket regenerated'); renderRoom(); } else alert('Err:'+ (r.error||''));
}

// Send chat
async function sendChat(roomId, fromUser, message){
  if(!message) return;
  await api('sendChat', {roomId, fromUser, message});
  renderRoom();
}

// Render room area
async function renderRoom(){
  const roomId = localStorage.getItem('roomId') || document.getElementById('joinRoomId').value.trim();
  if(!roomId){ document.getElementById('roomArea').innerHTML = '<div class="card small">No room selected</div>'; return; }
  const res = await api('getRoom', {roomId});
  if(!res.ok){ document.getElementById('roomArea').innerHTML = '<div class="card small">Room not found</div>'; return; }
  const {room, players, tickets, drawn, winners, chat, dividendConfig} = res;
  const hostToken = localStorage.getItem('hostToken');
  const isHost = hostToken && hostToken === room.hostToken;
  let html = '';
  html += `<div class="card"><div style="display:flex;gap:12px;align-items:center"><div><b>Room:</b> ${room.roomId}</div><div class="small">Host: ${room.hostName}</div><div class="small">Players: ${players.length}</div>`;
  if(isHost) html += `<div style="margin-left:auto"><button id="drawBtn">Draw Number</button> <button id="checkBtn">Check Winners</button></div>`;
  html += `</div></div>`;

  // drawn numbers
  html += `<div class="card"><div><b>Drawn Numbers</b></div><div style="margin-top:8px">`;
  for(let i=1;i<=90;i++){
    const cls = drawn.indexOf(i) !== -1 ? 'num-drawn' : 'num-badge';
    html += `<span class="${cls}">${i}</span>`;
  }
  html += `</div></div>`;

  // players grid
  html += `<div class="grid">`;
  players.forEach(p=>{
    const ticketRow = tickets.find(t=> t.playerId === p.playerId);
    const ticket = ticketRow ? JSON.parse(ticketRow.ticketJSON || ticketRow.ticket || '[]') : [];
    html += `<div class="card"><div style="display:flex;align-items:center;justify-content:space-between"><div><b>${p.name}</b></div><div class="small">${p.playerId}</div></div>`;
    if(ticket && ticket.length){
      html += `<div class="ticket">${renderTicketHtml(ticket, drawn)}</div>`;
    } else html += `<div class="small">Ticket pending</div>`;
    if(localStorage.getItem('playerId') === p.playerId) html += `<div style="margin-top:8px"><button id="regenBtn">Regenerate Ticket</button></div>`;
    html += `</div>`;
  });
  html += `</div>`;

  // winners list
  html += `<div class="card"><div><b>Winners</b></div><div style="margin-top:8px">`;
  if(winners && winners.length){
    winners.forEach(w=>{
      const meta = (()=>{ try{return JSON.parse(w.meta||w.meta||'{}')}catch(e){return {}} })();
      html += `<div class="small">[${w.winnerType}] Player: ${w.playerId} | Ticket: ${w.ticketId} | Payout: ${meta.payout||0} | At: ${w.recordedAt}</div>`;
    });
  } else html += `<div class="small">No winners yet</div>`;
  html += `</div></div>`;

  // chat
  html += `<div class="card"><div><b>Chat</b></div><div class="chat-box" id="chatBox">`;
  (chat || []).forEach(c=> html += `<div class="small"><b>${c.fromUser}:</b> ${c.message} <span class="small" style="opacity:0.6">(${new Date(c.createdAt).toLocaleTimeString()})</span></div>`);
  html += `</div><div style="display:flex;gap:8px;margin-top:8px"><input id="chatInput" placeholder="Type message"><button id="sendChatBtn">Send</button></div></div>`;

  document.getElementById('roomArea').innerHTML = html;

  if(isHost){
    document.getElementById('drawBtn').addEventListener('click', hostDraw);
    document.getElementById('checkBtn').addEventListener('click', async ()=>{ await api('checkWinners', {roomId}); alert('Checked winners'); renderRoom(); });
  }
  const regen = document.getElementById('regenBtn'); if(regen) regen.addEventListener('click', regenerateTicket);
  document.getElementById('sendChatBtn').addEventListener('click', ()=>{ const msg = document.getElementById('chatInput').value.trim(); if(!msg) return; sendChat(roomId, localStorage.getItem('playerId') || localStorage.getItem('hostName') || 'Anon', msg); document.getElementById('chatInput').value=''; });
}

function renderTicketHtml(ticket, drawn){
  let html = '<table class="ticket-table">';
  for(let r=0;r<3;r++){
    html += '<tr>';
    for(let c=0;c<9;c++){
      const v = ticket[r][c];
      if(v === null || v === undefined) html += `<td class="empty">-</td>`;
      else {
        const cls = drawn.indexOf(v) !== -1 ? 'num-drawn' : 'num-badge';
        html += `<td class="${cls}">${v}</td>`;
      }
    }
    html += '</tr>';
  }
  html += '</table>';
  return html;
}

// initial render if local room exists
window.addEventListener('load', ()=>{ if(localStorage.getItem('roomId')) renderRoom(); });

</script>
</body>
</html>
